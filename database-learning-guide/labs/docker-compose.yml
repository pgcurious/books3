version: '3.8'

# PostgreSQL Primary-Replica Setup for Learning
# Usage: docker-compose up -d

services:
  primary:
    image: postgres:15
    container_name: pg-primary
    environment:
      POSTGRES_USER: labuser
      POSTGRES_PASSWORD: labpassword
      POSTGRES_DB: labdb
    command: |
      postgres
      -c wal_level=replica
      -c max_wal_senders=3
      -c max_replication_slots=3
      -c hot_standby=on
      -c synchronous_commit=on
    ports:
      - "5432:5432"
    volumes:
      - primary_data:/var/lib/postgresql/data
    networks:
      - pgnet
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U labuser -d labdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  replica:
    image: postgres:15
    container_name: pg-replica
    environment:
      POSTGRES_USER: labuser
      POSTGRES_PASSWORD: labpassword
      POSTGRES_DB: labdb
      PGUSER: labuser
      PGPASSWORD: labpassword
    depends_on:
      primary:
        condition: service_healthy
    ports:
      - "5433:5432"
    volumes:
      - replica_data:/var/lib/postgresql/data
    networks:
      - pgnet
    cap_add:
      - NET_ADMIN  # For tc (traffic control) commands
    command: |
      bash -c "
      # Wait for primary to be ready
      until pg_isready -h primary -p 5432 -U labuser; do
        echo 'Waiting for primary...'
        sleep 2
      done

      # Check if already initialized as replica
      if [ ! -f /var/lib/postgresql/data/standby.signal ]; then
        echo 'Initializing replica from primary...'
        rm -rf /var/lib/postgresql/data/*
        PGPASSWORD=labpassword pg_basebackup -h primary -U labuser -D /var/lib/postgresql/data -Fp -Xs -P -R
      fi

      echo 'Starting replica...'
      postgres -c hot_standby=on
      "

volumes:
  primary_data:
  replica_data:

networks:
  pgnet:
    driver: bridge
